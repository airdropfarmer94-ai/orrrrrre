<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ORE Custom Tiles Bot (v3) - Privy Loader</title>

  <!-- Third-party libs -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.2/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>

  <style>
    body{margin:0;background:#000;color:#0f0;font-family:Arial;text-align:center;padding:20px;}
    h1{font-size:40px;margin:20px 0;}
    button{padding:18px 36px;margin:15px;background:#00ff00;color:black;border:none;border-radius:12px;font-size:22px;font-weight:bold;cursor:pointer;}
    button:disabled{background:#555;cursor:not-allowed;}
    button.stop{background:#ff0033;}
    #grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;max-width:420px;margin:40px auto;}
    .tile{width:70px;height:70px;background:#b8860b;color:white;font-size:28px;font-weight:bold;display:flex;align-items:center;justify-content:center;cursor:pointer;border:4px solid #333;border-radius:12px;}
    .tile.selected{background:#00ff00;color:black;border-color:#00ff00;box-shadow:0 0 20px #0f0;}
    .log{background:#111;padding:20px;height:380px;overflow-y:auto;margin:30px auto;max-width:700px;border-radius:12px;font-family:monospace;font-size:15px;border:1px solid #0f0;}
    input{padding:15px;width:280px;margin:15px;border-radius:12px;background:#222;color:#0f0;border:2px solid #0f0;font-size:18px;text-align:center;}
    #status {color:#0f0;margin:6px 0;font-size:14px;}
  </style>
</head>
<body>
  <h1>ORE Custom Tiles Bot (v3)</h1>
  <div id="root"></div>

<script>
/*
  Privy loader with primary+fallback URLs and verbose diagnostics.
  Updated to try jsDelivr first (https://cdn.jsdelivr.net/npm/privy/core.umd.min.js),
  then the auth.privy.io URL, then a local fallback /core.umd.min.js.

  NOTE: For production, pin a version: https://cdn.jsdelivr.net/npm/privy@<version>/core.umd.min.js
*/

const APP_CONFIG = window.APP_CONFIG || {
  PRIVY_APP_ID: "cmi8rgcw9008nl30cnnxgn9mw",
  RPC: "https://mainnet.helius-rpc.com/?api-key=8952f5e0-8f66-465a-8a4c-29152df1f3cd"
};

/* Try jsDelivr first, then auth.privy.io, then local fallback */
const PRIVY_URLS = [
  "https://cdn.jsdelivr.net/npm/privy/core.umd.min.js",
  "https://auth.privy.io/core.umd.min.js",
  "/core.umd.min.js"
];

let uiLogCallback = null;
function uiLog(msg) {
  try { console.log(msg); } catch(e){}
  if (typeof uiLogCallback === 'function') uiLogCallback(msg);
}

function listMethods(obj) {
  if (!obj) return [];
  try { return Object.getOwnPropertyNames(obj).filter(k=>typeof obj[k] === 'function'); } catch(e) { return []; }
}

/* Build a global promise that tries each URL until one loads and registers a global */
window.PrivyReady = (function() {
  if (window.PrivyReady) return window.PrivyReady;
  return new Promise((resolve, reject) => {
    let tried = 0;
    const tryNext = () => {
      if (tried >= PRIVY_URLS.length) {
        reject({ reason: 'all-failed', tried: PRIVY_URLS });
        return;
      }
      const url = PRIVY_URLS[tried++];
      uiLog(`Attempting to load Privy UMD from: ${url}`);
      const s = document.createElement('script');
      s.src = url;
      s.async = true;
      s.crossOrigin = 'anonymous';
      let timer = setTimeout(() => {
        uiLog(`Loading ${url} timed out after 10s`);
        s.onerror = s.onload = null;
        s.remove();
        tryNext();
      }, 10000);

      s.onload = () => {
        clearTimeout(timer);
        setTimeout(() => {
          if (window.Privy || window.privy) {
            uiLog(`Loaded Privy UMD from ${url}. exposed: ${window.Privy ? 'window.Privy' : 'window.privy'}`);
            resolve({ url, object: window.Privy ? 'Privy' : 'privy' });
          } else {
            uiLog(`Script loaded from ${url} but global not present. Trying next fallback.`);
            s.remove();
            tryNext();
          }
        }, 50);
      };

      s.onerror = (ev) => {
        clearTimeout(timer);
        uiLog(`Failed to load ${url} (network error). Trying next fallback if any.`);
        s.onerror = s.onload = null;
        s.remove();
        tryNext();
      };

      document.head.appendChild(s);
    };
    tryNext();
  });
})();

/* Minimal app UI for diagnostics and login */
const { useState, useEffect } = React;

function App() {
  const [status, setStatus] = useState("Waiting for Privy...");
  const [log, setLog] = useState([`${new Date().toLocaleTimeString()}: Ready`]);

  useEffect(() => { uiLogCallback = m => setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: ${m}`]); }, []);

  useEffect(() => {
    setStatus("Loading Privy UMD...");
    window.PrivyReady.then(info => {
      setStatus(`Privy loaded (${info.object})`);
      uiLog(`PrivyReady resolved: ${JSON.stringify(info)}`);
      setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Privy loaded (${info.object}) from ${info.url}`]);
    }).catch(err => {
      setStatus("Privy load failed");
      uiLog("PrivyReady rejected: " + JSON.stringify(err));
      setLog(l => [...l.slice(-49),
        `${new Date().toLocaleTimeString()}: Privy load failed — diagnostics: ${JSON.stringify(err)}`,
        `${new Date().toLocaleTimeString()}: Next: open DevTools → Network, look for requests to the Privy URLs (status/size).`,
        `${new Date().toLocaleTimeString()}: If 404/403: confirm the UMD URL or host locally at /core.umd.min.js.`
      ]);
    });
  }, []);

  const login = async () => {
    setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: SIGN IN clicked`]);
    setStatus("Attempting sign in...");
    try {
      const info = await window.PrivyReady;
      setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Privy loaded (${info.object}), attempting login.`]);

      if (window.privy && typeof window.privy.login === 'function') {
        setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Calling window.privy.login()`]);
        try { const r = window.privy.login(); if (r && typeof r.then === 'function') await r; setStatus('Login invoked'); return; } catch(e) { setLog(l => [...l.slice(-49), `window.privy.login threw: ${e && e.message}`]); }
      }
      if (window.Privy && typeof window.Privy === 'function') {
        setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Calling new window.Privy(...)`]);
        try {
          const inst = new window.Privy({ appId: APP_CONFIG.PRIVY_APP_ID, chainId: 101 });
          window.privy = window.privy || inst;
          const methods = listMethods(inst);
          setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Privy instance created. methods: ${methods.join(', ')}`]);
          if (typeof inst.login === 'function') { await inst.login(); setStatus('Login invoked'); return; }
          if (typeof inst.open === 'function') { inst.open(); setStatus('Open invoked'); return; }
          if (typeof inst.signIn === 'function') { await inst.signIn(); setStatus('SignIn invoked'); return; }
        } catch (e) {
          setLog(l => [...l.slice(-49), `Privy instance call threw: ${e && e.message}`]);
        }
      }

      setLog(l => [...l.slice(-49),
        `${new Date().toLocaleTimeString()}: Could not invoke Privy login. Diagnostic snapshot:`,
        `window.Privy defined: ${!!window.Privy}`,
        `window.privy defined: ${!!window.privy}`,
        `window.Privy methods: ${listMethods(window.Privy).join(', ')}`,
        `window.privy methods: ${listMethods(window.privy).join(', ')}`,
        `APP_CONFIG: ${JSON.stringify(APP_CONFIG)}`
      ]);
      setStatus("Privy login could not be invoked (see log)");
    } catch (err) {
      setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: PrivyReady error: ${JSON.stringify(err)}`]);
      setStatus("Privy not available");
    }
  };

  return React.createElement('div', null,
    React.createElement('div', null,
      React.createElement('button', {onClick: login, style:{fontSize:'28px',padding:'20px 60px'}}, "SIGN IN WITH PRIVY"),
      React.createElement('div', {id:'status'}, status),
      React.createElement('div',{className:'log'},log.map((l,i)=>React.createElement('div',{key:i},l)))
    )
  );
}

/* mount */
(function mount() {
  const rootEl = document.getElementById('root');
  if (ReactDOM && ReactDOM.createRoot) {
    ReactDOM.createRoot(rootEl).render(React.createElement(App));
  } else {
    ReactDOM.render(React.createElement(App), rootEl);
  }
})();
</script>
</body>
</html>
