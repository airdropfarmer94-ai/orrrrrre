<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ORE Custom Tiles Bot (v3) - Privy Loader</title>

  <!-- Third-party libs -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.2/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>

  <style>
    body{margin:0;background:#000;color:#0f0;font-family:Arial;text-align:center;padding:20px;}
    h1{font-size:40px;margin:20px 0;}
    button{padding:18px 36px;margin:15px;background:#00ff00;color:black;border:none;border-radius:12px;font-size:22px;font-weight:bold;cursor:pointer;}
    button:disabled{background:#555;cursor:not-allowed;}
    button.stop{background:#ff0033;}
    #grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;max-width:420px;margin:40px auto;}
    .tile{width:70px;height:70px;background:#b8860b;color:white;font-size:28px;font-weight:bold;display:flex;align-items:center;justify-content:center;cursor:pointer;border:4px solid #333;border-radius:12px;}
    .tile.selected{background:#00ff00;color:black;border-color:#00ff00;box-shadow:0 0 20px #0f0;}
    .log{background:#111;padding:20px;height:380px;overflow-y:auto;margin:30px auto;max-width:700px;border-radius:12px;font-family:monospace;font-size:15px;border:1px solid #0f0;}
    input{padding:15px;width:280px;margin:15px;border-radius:12px;background:#222;color:#0f0;border:2px solid #0f0;font-size:18px;text-align:center;}
    #status {color:#0f0;margin:6px 0;font-size:14px;}
  </style>
</head>
<body>
  <h1>ORE Custom Tiles Bot (v3)</h1>
  <div id="root"></div>

<script>
/*
  Privy loader + diagnostics

  Problem observed:
  - user clicked SIGN IN but window.Privy / window.privy never appeared.
  - No console error shown previously.

  This updated script:
  - attempts to dynamically load the Privy UMD script and reports load success/failure.
  - exposes a promise window.PrivyReady that resolves when the UMD script registers window.Privy (or window.privy), or rejects with an error object containing details.
  - the app's login() now awaits window.PrivyReady and shows concise diagnostics when the script cannot be loaded.
  - This helps determine whether the issue is: network 404/block, CSP, or the script exposes a different global name.
*/

/* ---------- CONFIG (you provided these) ---------- */
const APP_CONFIG = window.APP_CONFIG || {
  PRIVY_APP_ID: "cmi8rgcw9008nl30cnnxgn9mw",
  RPC: "https://mainnet.helius-rpc.com/?api-key=8952f5e0-8f66-465a-8a4c-29152df1f3cd"
};

/* The Privy UMD URL used previously */
const PRIVY_UMD_URL = "https://auth.privy.io/core.umd.min.js";

/* Global promise that resolves when Privy is available or rejects with diagnostics */
(function setupPrivyLoader() {
  if (window.PrivyReady) return; // already set
  window.PrivyReady = new Promise((resolve, reject) => {
    // If Privy is already present (from the page), resolve immediately
    if (window.Privy || window.privy) {
      return resolve({ source: 'already-present', object: !!window.Privy ? 'Privy' : 'privy' });
    }

    // Attempt to load the script dynamically
    const s = document.createElement('script');
    s.src = PRIVY_UMD_URL;
    s.async = true;
    s.crossOrigin = 'anonymous';

    let timedOut = false;
    const timeout = setTimeout(() => {
      timedOut = true;
      const err = {
        reason: 'timeout',
        message: `Loading ${PRIVY_UMD_URL} timed out after 10s.`,
        url: PRIVY_UMD_URL
      };
      reject(err);
    }, 10000);

    s.onload = () => {
      clearTimeout(timeout);
      // Wait a short tick for the UMD to register globals
      setTimeout(() => {
        if (window.Privy || window.privy) {
          resolve({ source: 'loaded', object: !!window.Privy ? 'Privy' : 'privy' });
        } else {
          // Script loaded but global not present -> possible UMD uses different global name or failed init
          reject({ reason: 'no-global', message: 'Script loaded but window.Privy/window.privy not defined', url: PRIVY_UMD_URL });
        }
      }, 50);
    };

    s.onerror = (ev) => {
      clearTimeout(timeout);
      // Provide as much diagnostic detail as possible
      reject({ reason: 'network-error', message: `Failed to load ${PRIVY_UMD_URL}`, url: PRIVY_UMD_URL, event: String(ev) });
    };

    // Append to head
    document.head.appendChild(s);
  });
})();

/* helper to list methods of an object safely */
function listMethods(obj) {
  if (!obj) return [];
  try {
    return Object.getOwnPropertyNames(obj).filter(k => typeof obj[k] === 'function');
  } catch (e) {
    return [];
  }
}

/* light diag logger that writes to console and later to UI via callback */
let uiLogCallback = null;
function diag(msg) {
  try { console.log(msg); } catch(e){}
  if (typeof uiLogCallback === 'function') uiLogCallback(msg);
}

/* ---------- Minimal app focused on login diagnostics ---------- */
const { useState, useEffect } = React;

function App() {
  const [status, setStatus] = useState("Waiting for Privy...");
  const [log, setLog] = useState([`${new Date().toLocaleTimeString()}: Ready`]);

  // expose UI log callback
  useEffect(() => { uiLogCallback = m => setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: ${m}`]); }, []);

  // Try to await PrivyReady at load to surface early failures
  useEffect(() => {
    setStatus("Attempting to load Privy UMD...");
    window.PrivyReady.then(info => {
      setStatus(`Privy loaded (${info.object})`);
      diag("PrivyReady resolved: " + JSON.stringify(info));
    }).catch(err => {
      setStatus("Privy load failed");
      diag("PrivyReady rejected: " + JSON.stringify(err));
      // Give extra guidance in the UI
      setLog(l => [...l.slice(-49),
        `${new Date().toLocaleTimeString()}: Privy load failed — see diagnostics below.`,
        `${new Date().toLocaleTimeString()}: ${JSON.stringify(err)}`
      ]);
    });
  }, []);

  // Robust login function that awaits PrivyReady then calls available method
  const login = async () => {
    setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: SIGN IN clicked`]);
    setStatus("Signing in... (awaiting Privy)");

    try {
      const info = await window.PrivyReady;
      diag("PrivyReady info: " + JSON.stringify(info));
      setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Privy loaded (${info.object}). Trying login method.`]);

      // If an instance already exists at window.privy, call its login
      if (window.privy && typeof window.privy.login === 'function') {
        diag("Calling window.privy.login()");
        try {
          const maybe = window.privy.login();
          if (maybe && typeof maybe.then === 'function') await maybe;
          setStatus("Invoked window.privy.login()");
          setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Called window.privy.login()`]);
          return;
        } catch (e) {
          diag("window.privy.login() threw: " + (e && e.message));
          setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: window.privy.login() threw: ${e && e.message}`]);
        }
      }

      // If the global constructor exists, instantiate and call common methods
      if (window.Privy && typeof window.Privy === 'function') {
        diag("window.Privy constructor found. Listing methods: " + listMethods(window.Privy).join(", "));
        try {
          const inst = new window.Privy({ appId: APP_CONFIG.PRIVY_APP_ID, chainId: 101 });
          window.privy = window.privy || inst;
          const methods = listMethods(inst);
          setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Created Privy instance. Methods: ${methods.join(", ")}`]);

          // Try common names
          if (typeof inst.login === 'function') {
            setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Calling instance.login()`]);
            await inst.login();
            setStatus("Invoked instance.login()");
            return;
          } else if (typeof inst.open === 'function') {
            setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Calling instance.open()`]);
            inst.open();
            setStatus("Invoked instance.open()");
            return;
          } else if (typeof inst.signIn === 'function') {
            setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Calling instance.signIn()`]);
            await inst.signIn();
            setStatus("Invoked instance.signIn()");
            return;
          } else {
            setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: No login/open/signIn on instance`]);
          }
        } catch (e) {
          setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: Error creating/calling instance: ${e && e.message}`]);
          diag("Privy instance creation error: " + (e && e.message));
        }
      }

      // If we reach here, no typical entrypoint worked
      setStatus("Could not invoke Privy login");
      setLog(l => [...l.slice(-49),
        `${new Date().toLocaleTimeString()}: Could not invoke Privy login. Diagnostic snapshot below:`,
        `${new Date().toLocaleTimeString()}: window.Privy defined: ${!!window.Privy}, window.privy defined: ${!!window.privy}`,
        `${new Date().toLocaleTimeString()}: window.Privy methods: ${listMethods(window.Privy).join(", ")}`,
        `${new Date().toLocaleTimeString()}: window.privy methods: ${listMethods(window.privy).join(", ")}`,
        `${new Date().toLocaleTimeString()}: APP_CONFIG: ${JSON.stringify(APP_CONFIG)}`
      ]);
    } catch (err) {
      // PrivyReady rejected; err contains diagnostic info from loader
      setStatus("Privy not available");
      setLog(l => [...l.slice(-49), `${new Date().toLocaleTimeString()}: PrivyReady error: ${JSON.stringify(err)}`]);
      diag("PrivyReady error: " + JSON.stringify(err));
      // Helpful follow-ups for the user:
      setLog(l => [...l.slice(-49),
        `${new Date().toLocaleTimeString()}: Next steps:`,
        "- Open DevTools → Network, filter by the script URL and check status (200/404/blocked).",
        "- If 404/403: confirm PRIVY script URL and network accessibility.",
        "- If blocked by CSP: add appropriate script-src in the server's CSP header or serve the script from your domain.",
        "- If the script loads but no global appears: the UMD may expose a different global; paste the loader diagnostic here and I'll adapt the code."
      ]);
    }
  };

  return React.createElement('div', null,
    React.createElement('div', null,
      React.createElement('button', {onClick: login, style:{fontSize:'28px',padding:'20px 60px'}}, "SIGN IN WITH PRIVY"),
      React.createElement('div', {id:'status'}, status),
      React.createElement('div',{className:'log'},log.map((l,i)=>React.createElement('div',{key:i},l)))
    )
  );
}

/* Mount app */
(function mount() {
  const rootEl = document.getElementById('root');
  if (ReactDOM && ReactDOM.createRoot) {
    ReactDOM.createRoot(rootEl).render(React.createElement(App));
  } else {
    ReactDOM.render(React.createElement(App), rootEl);
  }
})();
</script>
</body>
</html>
